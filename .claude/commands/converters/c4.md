---
description: C4-Architekturdiagramme aus vorhandenen Design-Dokumenten generieren
argument-hint: [--restart]
allowed-tools: Read, Edit, Write
---

## Zweck
Aus den **Design-Dokumenten** (`design/*.md`) und **Context-Informationen** (`context/*.md`) wird eine vollständige, **ausführliche** C4-Architekturdokumentation generiert. Das Command analysiert vorhandene Strukturen und erstellt die fünf C4-Ebenen mit umfangreichen Textbeschreibungen und ergänzenden Mermaid-Diagrammen.

**Fokus auf Content-Tiefe**: Jede C4-Ebene soll substanziellen Textinhalt haben - nicht nur Diagramme mit kurzen Erklärungen, sondern detaillierte Architekturanalyse mit Business-Kontext, technischen Details und Begründungen.

## Eingaben
- **Basis-Referenz:** `design/*.md`
- **Context:** `context/*.md`
- **Optional:** `--restart` (sichert alte Version und startet neu)

## Outputs
- **Verzeichnis:** `export/c4/` mit modularer Struktur
- **Sprache:** Deutsch, wenn nicht vom Nutzer anders gefordert
- **Index:** `export/c4/INDEX.md` (Übersicht und Navigation)
- **Kapitel:** Separate `.md`-Dateien pro C4-Ebene
- **Diagramme:** Separate `.mmd`-Dateien pro Diagramm

## Vorgehen
1) **Backup bei --restart**: Falls `export/c4/` existiert:
   - Erstelle `export/backup-{timestamp}/c4/` (komplettes Verzeichnis)
   - Starte komplett neu

2) **Update-Modus**: Ohne `--restart` bei existierendem Verzeichnis:
   - Analysiere bestehende `export/c4/` Struktur
   - Identifiziere Änderungen in Source-Dokumenten
   - Führe Refinement/Update durch

3) **Analyse**: Lese alle relevanten Design- und Context-Dokumente:
   - `design/structure.md` → Container und Komponenten identifizieren
   - `design/selections.md` → Technologieentscheidungen extrahieren  
   - `design/operability.md` → Deployment-Szenarien ableiten
   - `context/domain.md` → Business-Kontext und externe Akteure
   - `context/integrations.md` → Externe Systeme und Schnittstellen

4) **C4-Mapping**: Transformiere gefundene Strukturen zu C4-Elementen:
   - **Level 1 (Context)**: System + externe Benutzer/Systeme aus Context
   - **Level 2 (Container)**: Services, Databases, Frontend aus Structure
   - **Level 3 (Components)**: Interne Module aus detaillierten Struktur-Infos
   - **Level 4 (Code)**: Falls Code-Details in Dokumenten vorhanden
   - **Level 5 (Deployment)**: Infrastruktur aus Operability-Docs

   **Ausführlichkeitsgrad**: Jede Ebene soll umfassendes Textmaterial enthalten:
   - **Detaillierte Beschreibungen**: Jedes Element ausführlich erklären (Zweck, Verantwortlichkeiten, Technologien)
   - **Interaktionsmuster**: Workflows und Kommunikationsmuster beschreiben  
   - **Quality Attributes**: Performance, Security, Reliability pro Element
   - **Business Context**: Geschäftskontext und Architekturentscheidungen erläutern
   - **Technische Details**: Protokolle, APIs, Datenstrukturen dokumentieren

5) **Content-First Approach**: Erstelle zuerst umfangreichen Textinhalt, dann Diagramme:
   - **Umfassende Textbeschreibungen**: Mindestens 3-5 Absätze pro Element
   - **Kontext und Begründungen**: Warum-Fragen beantworten, nicht nur Was-Fragen
   - **Beispiele und Szenarien**: Konkrete Anwendungsfälle und Workflows
   - **Architekturentscheidungen**: Begründung für gewählte Lösungsansätze

6) **Diagramm-Generierung**: Nach dem Text erstelle separate `.mmd`-Dateien:
   - Verwende camelCase-Namenskonventionen  
   - Medium Abstraktionslevel
   - Konsistente Farb- und Symbol-Kodierung
   - **NUR** in `.mmd`-Dateien, NIEMALS in Markdown eingebettet
   - Referenziere die `.mmd`-Datei im Markdown mit Link und kurzer Erklärung
   - **WICHTIG**: Verwende nach der Erstellung der `.mmd`-Dateien den `mermaid-expert` Subagent, um die Mermaid-Syntax zu validieren und zu korrigieren

7) **Validierung**: Prüfe auf:
   - Dependency-Zyklen zwischen Komponenten
   - Konsistenz zwischen den Ebenen
   - Vollständigkeit der Schnittstellen-Beschreibungen

8) **Template-Anwendung**: Nutze `templates/c4.md` als Strukturbasis

9) **Review**: Zeige Struktur der zu erstellenden/aktualisierenden `export/c4/` Dateien

10) **Schreiben**: Nach Bestätigung Verzeichnisstruktur erstellen/aktualisieren

## Formatvorgaben
### Verzeichnisstruktur `export/c4/`
```
export/c4/
├── INDEX.md                    # Navigation und Übersicht
├── 01-context.md              # Level 1: Kontextdiagramm
├── 01-context.mmd             # Mermaid-Diagramm für Context
├── 02-containers.md           # Level 2: Container
├── 02-containers.mmd          # Mermaid-Diagramm für Container
├── 03-components.md           # Level 3: Komponenten
├── 03-components.mmd          # Mermaid-Diagramm für Komponenten
├── 04-deployment.md           # Level 4: Deployment
└── 04-deployment.mmd          # Mermaid-Diagramm für Deployment
```

### INDEX.md Format
- **Metadata**: System, Version, Agent-ID, Timestamp
- **Navigation**: Links zu allen Kapiteln
- **System Übersicht**: Umfassende Systembeschreibung (3-4 Absätze)
- **Architekturprinzipien**: Zentrale Designentscheidungen und Begründungen
- **Quality Attributes**: Performance-, Security-, Reliability-Anforderungen
- **Business Context**: Stakeholder, Geschäftsziele, Compliance-Anforderungen
- **Validierungsregeln**: Status der automatischen Konsistenz-Checks

### Content-Struktur pro C4-Ebene
Jede `.md`-Datei soll folgende Struktur haben:

1. **Purpose & Overview** (2-3 Absätze): Zweck und Einordnung der Ebene
2. **Diagram Reference**: Link zur entsprechenden `.mmd`-Datei
3. **Detailed Elements** (3-5 Absätze pro Element): 
   - Ausführliche Beschreibung jedes Architekturelements
   - Technologien, Verantwortlichkeiten, Designentscheidungen
   - Business-Rationale und Architektur-Trade-offs
4. **Interaction Patterns** (2-3 Absätze): Kommunikationsmuster und Workflows
5. **Quality Attributes** (2-3 Absätze): Performance, Security, Reliability

**WICHTIG**: Mermaid-Diagramme werden NUR in separaten `.mmd`-Dateien gespeichert, NICHT in Markdown eingebettet!

### Diagramm-Referenzierung
Anstatt Mermaid-Code direkt einzubetten, verweise auf die externe `.mmd`-Datei:

```markdown
## Diagram

[Context Diagram](01-context.mmd)

*Das Diagramm zeigt die Systemgrenzen und externen Akteure.*
```

**Dateistruktur**:
- `01-context.md` → enthält nur Text und Verweis
- `01-context.mmd` → enthält nur Mermaid-Code

**Konventionen für `.mmd`-Dateien**:
```
graph TD
    user[User] --> system[System Name]
    system --> database[(Database)]
    system --> external[External API]
```

## Backup-Struktur
Bei `--restart`:
```
export/
├── c4/                         # Neue modulare Version
│   ├── INDEX.md
│   ├── 01-context.md
│   └── ...
└── backup-20240821-143022/     # Timestamp-Ordner
    └── c4/                     # Gesichertes Verzeichnis
        ├── INDEX.md
        └── ...
```
