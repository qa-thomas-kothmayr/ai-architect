---
description: C4-Architekturdiagramme aus vorhandenen Design-Dokumenten generieren
argument-hint: [--restart]
allowed-tools: Read, Edit, Write
---

## Zweck
Aus den **Design-Dokumenten** (`design/*.md`) und **Context-Informationen** (`context/*.md`) wird eine vollständige, **ausführliche** C4-Architekturdokumentation generiert. Das Command analysiert vorhandene Strukturen und erstellt die fünf C4-Ebenen mit umfangreichen Textbeschreibungen und ergänzenden Mermaid-Diagrammen.

**Fokus auf Content-Tiefe**: Jede C4-Ebene soll substanziellen Textinhalt haben - nicht nur Diagramme mit kurzen Erklärungen, sondern detaillierte Architekturanalyse mit Business-Kontext, technischen Details und Begründungen.

## Eingaben
- **Basis-Referenz:** `design/*.md`
- **Context:** `context/*.md`
- **Optional:** `--restart` (sichert alte Version und startet neu)

## Outputs
- **Verzeichnis:** `export/c4/` mit modularer Struktur
- **Sprache:** Ausschließlich Deutsch (alle Inhalte, Diagramm-Labels, Metadaten)
- **Index:** `export/c4/INDEX.md` (Übersicht und Navigation)
- **Kapitel:** Separate `.md`-Dateien pro C4-Ebene
- **Diagramme:** Separate `.mmd`-Dateien pro Diagramm

## Vorgehen
1) **Backup bei --restart**: Falls `export/c4/` existiert:
   - Erstelle `export/backup-{timestamp}/c4/` (komplettes Verzeichnis)
   - Starte komplett neu

2) **Update-Modus**: Ohne `--restart` bei existierendem Verzeichnis:
   - Analysiere bestehende `export/c4/` Struktur
   - Identifiziere Änderungen in Source-Dokumenten
   - Führe Refinement/Update durch

3) **Content Generation Strategy**:
   - Automatische Inhaltsverzeichnis-Generierung für INDEX.md
   - Hierarchische Überschriftenstruktur (H1 für Ebenen-Titel, H2 für Element-Gruppen, H3 für Details)
   - C4-Modell Konsistenzvalidierung (Ebenen-Beziehungen prüfen)
   - Navigierbare Querverweise zwischen C4-Ebenen

4) **Analyse**: Lese alle relevanten Design- und Context-Dokumente:
   - `design/structure.md` → Container und Komponenten identifizieren
   - `design/selections.md` → Technologieentscheidungen extrahieren  
   - `design/operability.md` → Deployment-Szenarien ableiten
   - `context/domain.md` → Business-Kontext und externe Akteure
   - `context/integrations.md` → Externe Systeme und Schnittstellen

5) **C4-Mapping**: Transformiere gefundene Strukturen zu C4-Elementen:
   - **Level 1 (Context)**: System + externe Benutzer/Systeme aus Context
   - **Level 2 (Container)**: Services, Databases, Frontend aus Structure
   - **Level 3 (Components)**: Interne Module aus detaillierten Struktur-Infos
   - **Level 4 (Code)**: Falls Code-Details in Dokumenten vorhanden
   - **Level 5 (Deployment)**: Infrastruktur aus Operability-Docs

   **Ausführlichkeitsgrad**: Jede Ebene soll umfassendes Textmaterial enthalten:
   - **Detaillierte Beschreibungen**: Jedes Element ausführlich erklären (Zweck, Verantwortlichkeiten, Technologien)
   - **Interaktionsmuster**: Workflows und Kommunikationsmuster beschreiben  
   - **Quality Attributes**: Performance, Security, Reliability pro Element
   - **Business Context**: Geschäftskontext und Architekturentscheidungen erläutern
   - **Technische Details**: Protokolle, APIs, Datenstrukturen dokumentieren

6) **Content-First Approach**: Erstelle zuerst umfangreichen Textinhalt, dann Diagramme:
   - **Umfassende Textbeschreibungen**: Mindestens 3-5 Absätze pro Element
   - **Kontext und Begründungen**: Warum-Fragen beantworten, nicht nur Was-Fragen
   - **Beispiele und Szenarien**: Konkrete Anwendungsfälle und Workflows
   - **Architekturentscheidungen**: Begründung für gewählte Lösungsansätze

7) **Diagramm-Generierung**: Nach dem Text erstelle separate `.mmd`-Dateien:
   - **Meaningful Groupings**: C4-konforme Boundary-Gruppierungen mit ebenen-spezifischen Farben
   - **Descriptive Relations**: Konkrete Verben für Interaktionen (z.B. "lädt Daten", "authentifiziert")
   - **Component Descriptions**: Detaillierte Responsibility-Annotations für jedes C4-Element
   - **Visual Hierarchy**: Klare Abstraktionsebenen entsprechend C4-Level
   - **Layout Optimization**: Reduzierte Komplexität, fokussiert auf relevante Beziehungen
   - **NUR** in `.mmd`-Dateien, NIEMALS in Markdown eingebettet
   - Referenziere die `.mmd`-Datei im Markdown mit Link und kurzer Erklärung
   - **WICHTIG**: Verwende nach der Erstellung der `.mmd`-Dateien den `mermaid-expert` Subagent, um die Mermaid-Syntax zu validieren und zu korrigieren

8) **Validierung**: Prüfe auf:
   - Dependency-Zyklen zwischen Komponenten
   - Konsistenz zwischen den C4-Ebenen (Context → Container → Components)
   - Vollständigkeit der Schnittstellen-Beschreibungen
   - C4-Modell Beziehungsvalidierung (kein Container ohne Context-Bezug)

9) **Template Structure Enhancement**:
   - **Template-Validierung**: Prüfe `templates/c4.md` auf Vollständigkeit vor Verwendung
   - **Beispiel-Content**: Template mit Muster-Inhalten als Leitfaden für C4-Generierung
   - **Validierung-Marker**: Kennzeichnung von Pflicht- vs. optionalen C4-Ebenen
   - **Cross-Reference-Templates**: Vordefinierte Verknüpfungsstrukturen zwischen C4-Levels
   - **Quality Gates**: Mindest-Elementanzahl und erforderliche Beschreibungen pro Ebene
   - **Smart Fallbacks**: Nur bei kritischen fehlenden C4-Elementen Interview-Fragen stellen
   - **Completeness Checks**: Markiere unvollständige C4-Ebenen explizit für spätere Ergänzung

10) **Review**: Zeige Struktur der zu erstellenden/aktualisierenden `export/c4/` Dateien

11) **Schreiben**: Nach Bestätigung Verzeichnisstruktur erstellen/aktualisieren

## Formatvorgaben
### Verzeichnisstruktur `export/c4/`
```
export/c4/
├── INDEX.md                    # Navigation und Übersicht
├── 01-context.md              # Level 1: Kontextdiagramm
├── 01-context.mmd             # Mermaid-Diagramm für Context
├── 02-containers.md           # Level 2: Container
├── 02-containers.mmd          # Mermaid-Diagramm für Container
├── 03-components.md           # Level 3: Komponenten
├── 03-components.mmd          # Mermaid-Diagramm für Komponenten
├── 04-deployment.md           # Level 4: Deployment
└── 04-deployment.mmd          # Mermaid-Diagramm für Deployment
```

## Content Quality Standards
- **Minimum content per section**: 3-5 substantive paragraphs mit technischer Tiefe
- **Developer-friendly language**: Klare "Was", "Warum", "Wie" Erklärungen
- **Practical examples**: API-Calls, Deployment-Szenarien, konkrete Workflows
- **Cross-referencing**: Verweise zwischen C4-Ebenen, ADRs, und externen Dokumenten
- **Visual organization**: Tabellen für Element-Vergleiche, Listen für Responsibilities
- **Terminology consistency**: Einheitliche Element-Bezeichnungen über alle Ebenen
- **Context provision**: Business-Rationale für Architektur-Entscheidungen

### INDEX.md Format
- **Metadata**: System, Version, Agent-ID, Timestamp, Source-Dokumente mit Pfaden
- **Navigation**: Links zu allen C4-Ebenen
- **System Übersicht**: Umfassende Systembeschreibung (3-4 Absätze)
- **Architekturprinzipien**: Zentrale Designentscheidungen und Begründungen
- **Quality Attributes**: Performance-, Security-, Reliability-Anforderungen
- **Business Context**: Stakeholder, Geschäftsziele, Compliance-Anforderungen
- **Completeness Status**: Explizite Markierung unvollständiger C4-Ebenen (⚠️ INCOMPLETE)
- **Validierungsregeln**: Status der automatischen Konsistenz-Checks

### Content-Struktur pro C4-Ebene
Jede `.md`-Datei soll folgende Struktur haben:

1. **Purpose & Overview** (2-3 Absätze, PFLICHT): Zweck und Einordnung der C4-Ebene
2. **Diagram Reference** (PFLICHT): Link zur entsprechenden `.mmd`-Datei
3. **Detailed Elements** (3-5 Absätze pro Element, PFLICHT): 
   - Ausführliche Beschreibung jedes Architekturelements (min. 150 Wörter pro Element)
   - Technologien, Verantwortlichkeiten, Designentscheidungen mit Begründung
   - Business-Rationale und Architektur-Trade-offs ("warum diese Lösung")
4. **Interaction Patterns** (2-3 Absätze, PFLICHT): Kommunikationsmuster und Workflows
5. **Quality Attributes** (2-3 Absätze, optional): Performance, Security, Reliability
6. **Cross-References** (PFLICHT):
   - `→ Übergeordnet: [Context Level](01-context.md)` (bei Container/Component Level)
   - `→ Detaillierung: [Components](03-components.md)` (bei Container Level) 
   - `→ Bezug zu: [ADR-YYYY](../adr/ADR-YYYY-titel.md)`

**Quality Gates pro C4-Ebene**:
- ✅ Mindestens 2 Architekturelemente pro Ebene
- ✅ Mindestens 1 Interaction Pattern beschrieben
- ✅ Mindestens 2 Cross-References zu anderen Ebenen/Dokumenten
- ✅ Begründung für C4-Element-Aufteilung

**WICHTIG**: Mermaid-Diagramme werden NUR in separaten `.mmd`-Dateien gespeichert, NICHT in Markdown eingebettet!

### Diagramm-Referenzierung
Anstatt Mermaid-Code direkt einzubetten, verweise auf die externe `.mmd`-Datei:

```markdown
## Diagram

[Context Diagram](01-context.mmd)

*Das Diagramm zeigt die Systemgrenzen und externen Akteure.*
```

**Dateistruktur**:
- `01-context.md` → enthält nur Text und Verweis
- `01-context.mmd` → enthält nur Mermaid-Code

**Konventionen für `.mmd`-Dateien** (C4 Context Level):
```
graph TD
    subgraph "External Users"
        user[Customer]:::personClass
        admin[Administrator]:::personClass
    end
    
    subgraph "System Boundary"
        system[E-Commerce System]:::systemClass
    end
    
    subgraph "External Systems"
        payment[Payment Gateway]:::externalClass
        email[Email Service]:::externalClass
    end
    
    user -->|"browst Produkte, kauft ein"| system
    admin -->|"verwaltet Katalog"| system
    system -->|"verarbeitet Zahlungen via"| payment
    system -->|"sendet Bestätigungen via"| email
    
    classDef personClass fill:#08427b,stroke:#073B6F,color:#fff
    classDef systemClass fill:#1168bd,stroke:#0b4884,color:#fff
    classDef externalClass fill:#999999,stroke:#6b6b6b,color:#fff
```

## Standardisierte Backup-Struktur
Bei `--restart` (einheitlich über alle Converter):
```
export/
├── c4/                              # Aktuelle Version
│   ├── INDEX.md
│   ├── 01-context.md
│   └── ...
└── backup-YYYYMMDD-HHMMSS/         # ISO 8601 Timestamp
    └── c4/                          # Gesicherte Version
        ├── INDEX.md
        ├── METADATA.md             # Backup-Info: Datum, Grund, Agent-Version
        └── ...
```

## Einheitliche Metadaten-Standards
- **Timestamp-Format**: ISO 8601 (YYYY-MM-DD HH:MM:SS)
- **Agent-Referenz**: Claude Code v{version} + Command-Name
- **Source-Tracking**: Vollständige Pfade zu genutzten Design-Dokumenten
- **Change-Log**: Kurze Beschreibung der Änderungen seit letztem Export
- **C4-Validierung**: Status der Level-Konsistenz und Element-Beziehungen
